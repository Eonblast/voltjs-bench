var b=require("os"),g=require("cli"),h=require("util"),j=require("cluster"),l=require("./voltdb-client-nodejs/lib/client"),m=require("./voltdb-client-nodejs/lib/query");require("./voltdb-client-nodejs/lib/query");var n=b.u().length,o="master  ",q=0,r=null;new m("Results");
var s=new m("Insert",["string","string","string"]),t=new m("Select",["string"]),u=0,v=g.parse({a:["c","Number of loops to run","number",1E4],j:["h","VoltDB host (any if multi-node)","string","localhost"],r:["f","client worker forks","number",n],i:["v","verbose output"],write:["w","write"],o:["r","read"],c:["n","numeric, sequential dummy data"],debug:["d","debug output"],g:["q","quieter output"],b:["l","TPS log frequency","number",1E4]}),w=v.r,A=z,B=!v.g||v.i||v.debug?z:function(){},C=v.i||v.debug?
z:function(){},D=v.debug?z:function(){},F="abcdefghijklmnopqrstuvwxyz",G=F.length;j.A?H():(o="worker "+process.v.s,D("worker main"),r=new l([{host:v.j,port:21212,H:"user",B:"password",G:"database",D:5E4}]),r.t(function(){D("Node up");D("voltInit");var a=v.a,d=[];d.push(I);d.push(J);K({a:a,h:d})},function(){B("Login error. Quitting.");process.k()}),D("connected"),process.f("message",function(a){console.log("Unknwon message:",a)}));
function H(){B("-- Forking Write Benchmark Client --");B("VoltDB host:  "+v.j);B("access: "+(v.write?"writes ":"")+(v.F?"reads ":""));B("values: "+(v.c?"numeric sequences":"random strings"));B("worker forks: "+w);for(var a=0;a<w;a++){D("forking worker #"+a);j.w().f("message",function(a){a.d&&a.d=="result"&&(u=u+a.q)})}var d=0;j.f("death",function(a){C("worker (pid "+a.C+") exits.");d++;if(d==w){var a=Math.round(u),f=Math.round(a/n),i=Math.round(a/w);A("Total: "+L(a)+" TPS = "+L(f)+" TPS/core  = "+
L(i)+" TPS/fork")}})}function J(){D("writeEnd");process.k()}
function I(a){function d(){if(v.write){var k=s.l();if(c<a.a){var x,y,e;if(v.c){e=M++*w+q;x="h"+e;y="w"+e;e="l"+e}else{x=N();y=N();e=N()}k.p([x,y,e]);r.call(k,function(){D("writes ",i);i--;if(i==0){O(E,a.a);K(a)}else D("writes ",i)},function(){if(c<a.a){if(c&&c%v.b==0){var f=c,e=(new Date).getTime()-p,i=v.b,k=Math.round(i*1E3/e);v.g?A(L(k)+" TPS writes"):B("Executed "+L(f)+" writes. Last "+L(i)+" in "+e+"ms --\> "+L(k)+" TPS "+h.m(process.n()));p=(new Date).getTime()}c++;process.e(d)}})}}if(v.o){k=
t.l();if(c<a.a){e=v.c?"l"+(M++*w+q):N();k.p([e]);r.call(k,function(){D("reads ",f);f--;if(f==0){O(E,a.a);K(a)}else D("reads ",f)},function(){if(c<a.a){if(c&&c%v.b==0){var e=(new Date).getTime()-p,f=v.b;B("Executed "+c+" reads. Last "+f+" in "+e+"ms --\> "+Math.round(f*1E3/e)+" TPS "+h.m(process.n()));p=(new Date).getTime()}c++;process.e(d)}})}}}var c=0,f=a.a,i=a.a,E=(new Date).getTime(),p=(new Date).getTime();process.e(d)}
function O(a,d){var c=Math.max(1,(new Date).getTime()-a),f=d*1E3/c;A(h.z("%s transactions in %s milliseconds --\> %s TPS",L(d),L(c),L(f)));process.send({d:"result",q:f})}function K(a){a.h.length>0&&a.h.shift()(a)}function z(a){a=a.replace(/\n/g,"\n"+o+": ");console.log(o+": "+a)}function N(){for(var a=1+Math.floor(Math.random()*19),d="",c=0;c<a;c++)d=d+F[Math.floor(Math.random()*G)];return d}function L(a){a=Math.floor(a).toString();return a=a.replace(/(\d)(\d\d\d)($|[,.])/,"$1,$2$3")}var M=0;
